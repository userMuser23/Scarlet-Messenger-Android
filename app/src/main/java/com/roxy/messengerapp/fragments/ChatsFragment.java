package com.roxy.messengerapp.fragments;import android.os.Bundle;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import androidx.annotation.NonNull;import androidx.fragment.app.Fragment;import androidx.navigation.Navigation;import androidx.recyclerview.widget.LinearLayoutManager;import androidx.recyclerview.widget.RecyclerView;import com.google.firebase.auth.FirebaseAuth;import com.google.firebase.auth.FirebaseUser;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.ValueEventListener;import com.roxy.messengerapp.R;import com.roxy.messengerapp.adapters.UserAdapter;import com.roxy.messengerapp.entities.Chatlist;import com.roxy.messengerapp.entities.User;import java.util.ArrayList;import java.util.List;public class ChatsFragment extends Fragment {    private RecyclerView recyclerView;    private UserAdapter userAdapter;    private List<User> mUsers; // Кого отображать    FirebaseUser fuser;    DatabaseReference reference;    private List<Chatlist> usersList; // Список ID собеседников    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        View view = inflater.inflate(R.layout.fragment_chats, container, false);        recyclerView = view.findViewById(R.id.recycler_view);        recyclerView.setHasFixedSize(true);        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));        fuser = FirebaseAuth.getInstance().getCurrentUser();        usersList = new ArrayList<>();        // 1. Сначала загружаем список ID из ветки Chatlist        reference = FirebaseDatabase.getInstance().getReference("Chatlist").child(fuser.getUid());        reference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                usersList.clear();                for (DataSnapshot snapshot : dataSnapshot.getChildren()){                    Chatlist chatlist = snapshot.getValue(Chatlist.class);                    usersList.add(chatlist);                }                // Как только получили список ID, идем загружать инфо о пользователях                chatList();            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        return view;    }    // 2. Метод сопоставления ID с реальными пользователями    private void chatList() {        mUsers = new ArrayList<>();        reference = FirebaseDatabase.getInstance().getReference("Users");        reference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                mUsers.clear();                for (DataSnapshot snapshot : dataSnapshot.getChildren()){                    User user = snapshot.getValue(User.class);                    // Самая хитрая часть: ищем совпадения                    // Мы бежим по всем юзерам базы и проверяем: "А есть ли этот парень в моем списке диалогов?"                    for (Chatlist chatlist : usersList){                        if (user != null && user.getId().equals(chatlist.getId())){                            mUsers.add(user);                        }                    }                }                // Настраиваем адаптер (используем тот же UserAdapter, что и во вкладке "Пользователи")                userAdapter = new UserAdapter(mUsers,new UserAdapter.OnUserClickListener() {                    @Override                    public void onUserClick(User user) {                        // При клике открываем чат                        Bundle bundle = new Bundle();                        bundle.putString("userid", user.getId());                        Navigation.findNavController(getView()).navigate(R.id.action_home_to_messageChat, bundle);                    }                }, true);                recyclerView.setAdapter(userAdapter);            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }}