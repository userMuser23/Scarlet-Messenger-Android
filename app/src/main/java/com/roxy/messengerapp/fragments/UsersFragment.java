package com.roxy.messengerapp.fragments;import android.os.Bundle;import android.text.Editable;import android.text.TextWatcher;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.EditText;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.fragment.app.Fragment;import androidx.navigation.Navigation;import androidx.recyclerview.widget.LinearLayoutManager;import androidx.recyclerview.widget.RecyclerView;import com.google.firebase.auth.FirebaseAuth;import com.google.firebase.auth.FirebaseUser;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.Query;import com.google.firebase.database.ValueEventListener;import com.roxy.messengerapp.R;import com.roxy.messengerapp.adapters.UserAdapter;import com.roxy.messengerapp.entities.User;import java.util.ArrayList;import java.util.List;public class UsersFragment extends Fragment {    private RecyclerView recyclerView;    private UserAdapter userAdapter;    private List<User> mUsers;    EditText search_users;    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        View view = inflater.inflate(R.layout.fragment_users, container, false);        // 1. Настройка RecyclerView        recyclerView = view.findViewById(R.id.rvUsers);        recyclerView.setHasFixedSize(true);        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));        search_users = view.findViewById(R.id.search_users);        // Инициализируем пустой список        mUsers = new ArrayList<>();        search_users.addTextChangedListener(new TextWatcher() {            @Override            public void beforeTextChanged(CharSequence charSequence, int i, int i1, int i2) {}            @Override            public void onTextChanged(CharSequence charSequence, int i, int i1, int i2) {                // Если поле пустое -> грузим всех                // Если есть текст -> ищем                searchUsers(charSequence.toString().toLowerCase());            }            @Override            public void afterTextChanged(Editable editable) {}        });        // 2. Запускаем чтение пользователей        readUsers();        return view;    }    private void searchUsers(String s) {        final FirebaseUser fuser = FirebaseAuth.getInstance().getCurrentUser();        // Магия Firebase: ищем по полю "search", начиная с введенного текста        Query query = FirebaseDatabase.getInstance().getReference("Users")                .orderByChild("search")                .startAt(s)                .endAt(s + "\uf8ff");        query.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                mUsers.clear();                for (DataSnapshot snapshot : dataSnapshot.getChildren()){                    User user = snapshot.getValue(User.class);                    assert user != null;                    assert fuser != null;                    // Не показываем себя в результатах                    if (!user.getId().equals(fuser.getUid())){                        mUsers.add(user);                    }                }                // Обновляем адаптер                userAdapter = new UserAdapter(mUsers, new UserAdapter.OnUserClickListener() {                    @Override                    public void onUserClick(User user) {                        Bundle bundle = new Bundle();                        bundle.putString("userid", user.getId());                        Navigation.findNavController(getView()).navigate(R.id.action_home_to_messageChat, bundle);                    }                }, false); // false = это не чат, скрываем last msg                recyclerView.setAdapter(userAdapter);            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {}        });    }    private void readUsers() {        // Получаем текущего юзера (чтобы не показывать его в списке)        final FirebaseUser firebaseUser = FirebaseAuth.getInstance().getCurrentUser();        // Ссылка на базу данных        DatabaseReference reference = FirebaseDatabase.getInstance().getReference("Users");        if (search_users.getText().toString().equals("")) {            reference.addValueEventListener(new ValueEventListener() {                @Override                public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                    // Очищаем список перед загрузкой (чтобы не дублировались при обновлении)                    mUsers.clear();                    // Пробегаем по всем детям узла "Users"                    for (DataSnapshot snapshot : dataSnapshot.getChildren()) {                        User user = snapshot.getValue(User.class);                        // Проверка на null и исключение себя из списка                        if (user != null && firebaseUser != null) {                            if (!user.getId().equals(firebaseUser.getUid())) {                                mUsers.add(user);                            }                        }                    }                    // Создаем и назначаем адаптер                    // Второй параметр - это наш слушатель клика (пока просто Toast)                    userAdapter = new UserAdapter(mUsers, new UserAdapter.OnUserClickListener() {                        @Override                        public void onUserClick(User user) {                            Bundle bundle = new Bundle();                            bundle.putString("userid", user.getId());                            Navigation.findNavController(getView())                                    .navigate(R.id.action_home_to_messageChat, bundle);                        }                    }, false);                    recyclerView.setAdapter(userAdapter);                }                @Override                public void onCancelled(@NonNull DatabaseError databaseError) {                    // Обработка ошибок (если нет интернета и т.д.)                }            });        }    }}